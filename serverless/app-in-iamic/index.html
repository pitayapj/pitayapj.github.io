
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pitayapj.github.io/serverless/app-in-iamic/">
      
      
        <link rel="prev" href="../../devops/about-devops/">
      
      
        <link rel="next" href="../../misc/driving/convert-license/convert-license/">
      
      
      <link rel="icon" href="../../common/img/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>Building an application in IAM Identity Center(SSO) - Pitaya Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../common/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-an-application-in-iam-identity-center" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Pitaya Blog" class="md-header__button md-logo" aria-label="Pitaya Blog" data-md-component="logo">
      
  <img src="../../common/img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Pitaya Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building an application in IAM Identity Center(SSO)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Pitaya Blog" class="md-nav__button md-logo" aria-label="Pitaya Blog" data-md-component="logo">
      
  <img src="../../common/img/logo.png" alt="logo">

    </a>
    Pitaya Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Devops
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Devops
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/about-devops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Devops
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Serverless
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Serverless
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Building an application in IAM Identity Center(SSO)
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Building an application in IAM Identity Center(SSO)
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam-identity-center" class="md-nav__link">
    <span class="md-ellipsis">
      IAM Identity Center
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      System Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#design" class="md-nav__link">
    <span class="md-ellipsis">
      Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement" class="md-nav__link">
    <span class="md-ellipsis">
      Implement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-setting-aws-pre-config-app" class="md-nav__link">
    <span class="md-ellipsis">
      1. Setting AWS Pre-config App
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-other-components-setup" class="md-nav__link">
    <span class="md-ellipsis">
      2. Other components setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-create-iam-ic-custom-app" class="md-nav__link">
    <span class="md-ellipsis">
      3. Create IAM-IC custom app
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    <span class="md-ellipsis">
      Result
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Result">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-cost" class="md-nav__link">
    <span class="md-ellipsis">
      Running cost
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Misc
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Driving
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Driving
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/driving/convert-license/convert-license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Convert Vietnam license(B2) to Japanese license(普通車)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/photography/photography/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Photography Notes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tags
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iam-identity-center" class="md-nav__link">
    <span class="md-ellipsis">
      IAM Identity Center
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      System Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#design" class="md-nav__link">
    <span class="md-ellipsis">
      Design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement" class="md-nav__link">
    <span class="md-ellipsis">
      Implement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-setting-aws-pre-config-app" class="md-nav__link">
    <span class="md-ellipsis">
      1. Setting AWS Pre-config App
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-other-components-setup" class="md-nav__link">
    <span class="md-ellipsis">
      2. Other components setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-create-iam-ic-custom-app" class="md-nav__link">
    <span class="md-ellipsis">
      3. Create IAM-IC custom app
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    <span class="md-ellipsis">
      Result
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Result">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-cost" class="md-nav__link">
    <span class="md-ellipsis">
      Running cost
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
<nav class="md-tags" >
  
    
    
    
      <a href="../../tags/tags/#aws" class="md-tag">AWS</a>
    
  
    
    
    
      <a href="../../tags/tags/#serverless" class="md-tag">Serverless</a>
    
  
    
    
    
      <a href="../../tags/tags/#cognito" class="md-tag">Cognito</a>
    
  
</nav>



<h1 id="building-an-application-in-iam-identity-center">Building an application in IAM Identity Center</h1>
<h2 id="introduction">Introduction</h2>
<h3 id="background">Background</h3>
<p>Working with AWS for so long, I think its <a href="https://aws.amazon.com/blogs/apn/the-6-pillars-of-the-aws-well-architected-framework/">pillars of well-architect</a> imprinted into my brain. </p>
<p>I always find a way to optimizing the cloud resources and one of the optimization aspect will be cost.</p>
<p>Even though I have introduced an automation to turn on/off for our services outside business hours (of course only for Development and Staging environment). 
Some of our projects are going in to maintenance phase, features and new functions need tested are not as many as before.</p>
<p>Our systems have too much un-use time. So, naturally I want a system that can turn on our infrastructure when we need.
And turn it off otherwise.</p>
<p>Of course we need to make sure that access to the system is secure, only accessible internally.</p>
<h3 id="iam-identity-center">IAM Identity Center</h3>
<h4> Introducing IAM Identity Center (IAM-IC)! </h4>

<p>Beside being a centralize access place to many of your AWS Accounts. IAM-IC also provide metadata so applications can have it as the identity provider. </p>
<p>Let's leverage that and also make sure that only IAM-IC authenticated users can access our app.</p>
<h2 id="system-implementation">System Implementation</h2>
<h3 id="design">Design</h3>
<p><img alt="AWSDiagram" src="iamic-app-design.png" />
There will be 2 major parts. One is our application backend and frontend reside in a centralized AWS account. </p>
<p class="annotate">Other will be process to turn on/off resources in registered satellite accounts. Which will be different for each, it could be a lambda function calling AWS API to turn on/off resources. Or in my case, since I created our resources with CDK, my process compose of a lambda function, a pipeline that will be trigger by that lambda function and spin up a Codebuild Instance and run command base on input receive from centralized account.(1) </p>
<ol>
<li>And if setting up turn on/off process is the same for every satellite accounts. You can create Service Catalog, share with the whole Organization for simplicity.</li>
</ol>
<p>The system will only have 2 extremely simple functions, list all infrastructures along with its status and changing status of one specific infrastructure environment. </p>
<p>Of course my lazy ass will try to avoid backend code as much as possible. So I will be using <a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/create/app?applicationId=arn:aws:serverlessrepo:us-east-1:520945424137:applications/cloudfront-authorization-at-edge">AWS Pre-config Authentication App</a>.</p>
<p class="annotate">The Pre-config app will create cloudfront distribution, user pool and lambda function that handles authentication process for us. (1) In addition, we will also need a few more components to handle various task in our system. I explain each component and its purpose below. But I won't go into detail how to set it up.</p>
<ol>
<li>Change to your prefer region before creating the app. Default is us-east-1.</li>
</ol>
<h4> Additional components for our system: </h4>
<dl>
<dt><code>IAM-IC</code></dt>
<dd>Our IDP which stores all users' information. Also being that starting point to access our application. I'm using our pre-existing IAM-IC so it's required a little bit of manual config.</dd>
<dt><code>Frontend bucket</code></dt>
<dd>Serve React's SPA statically. Authenticate access with Cognito user pool created by AWS Pre-config app.</dd>
<dt><code>Backend API Gateway</code></dt>
<dd>API front for our backend function, user must authenticated with Cognito user pool created by AWS Pre-config app.</dd>
<dt><code>Backend Function</code></dt>
<dd>Handle request accordingly. For now I only have 2 functions, read all infra status and change status to on/off of a specify infra environment.</dd>
<dt><code>Status DynamoDB</code></dt>
<dd>Database to store status of all infra environments.</dd>
<dt><code>DynamoDB stream</code></dt>
<dd>Streaming whenever there is a change in one of our records. Trigger data processing lambda function.</dd>
<dt><code>Event Publisher Function</code></dt>
<dd>Receive data from dynamoDB stream and publish a SNS topic with attribute</dd>
<dt><code>Change SNS Topic</code></dt>
<dd>Send message to all subscribers in all accounts. Each subscription will have a filtering to check if the message destined to its account then process with appropriate action..</dd>
</dl>
<h3 id="implement">Implement</h3>
<h4 id="1-setting-aws-pre-config-app">1. Setting AWS Pre-config App</h4>
<p>The purpose of AWS Pre-config App is to handle authentication for any content hosting through Cloudfront.</p>
<p>In our case, we want to serve a SPA app in S3 bucket. So there will be a few parameter we need to change when creating the app.</p>
<h5>Parameters in AWS Pre-config App:</h5>

<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
<th style="text-align: left;">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>HttpHeaders</code></td>
<td style="text-align: left;">{  "Content-Security-Policy": "default-src 'none'; img-src 'self'; script-src 'self' https://code.jquery.com https://stackpath.bootstrapcdn.com; style-src 'self' 'unsafe-inline' https://stackpath.bootstrapcdn.com; object-src 'none'; connect-src 'self' https://<em>.amazonaws.com https://</em>.amazoncognito.com <strong>https://your-backend-url.com</strong>",  "Strict-Transport-Security": "max-age=31536000; includeSubdomains; preload",  "Referrer-Policy": "same-origin",  "X-XSS-Protection": "1; mode=block",  "X-Frame-Options": "DENY",  "X-Content-Type-Options": "nosniff"}</td>
<td style="text-align: left;">Add backend URL to connect-src part of Content-Security-Policy if URL of your backend and frontend is different. If not set, you will encounter error when calling backend</td>
</tr>
<tr>
<td style="text-align: left;"><code>OriginAccessIdentity</code></td>
<td style="text-align: left;">something like EABCDEFGH123</td>
<td style="text-align: left;">Create OAI first then include its ID here</td>
</tr>
<tr>
<td style="text-align: left;"><code>S3OriginDomainName</code></td>
<td style="text-align: left;"><strong>content-bucket-name</strong>.s3.<strong>ap-northeast-1</strong>.amazonaws.com</td>
<td style="text-align: left;">S3 origin domain will be in format:<br> <strong>bucket-name</strong>.s3.<strong>region</strong>.amazonaws.com</td>
</tr>
<tr>
<td style="text-align: left;"><code>RedirectPathSignOut</code></td>
<td style="text-align: left;">I set it to/signedout</td>
<td style="text-align: left;">A page to redirect user when signed out</td>
</tr>
<tr>
<td style="text-align: left;"><code>SignOutUrl</code></td>
<td style="text-align: left;">I set it to /signout</td>
<td style="text-align: left;">Url that when request, it will sign user out</td>
</tr>
</tbody>
</table>
<h4 id="2-other-components-setup">2. Other components setup</h4>
<p>Creating other components, we can use <a href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html">CDK</a> and I highly recommend doing it that way.
But because CDK haven't support changing attribute of imported distribution yet. We need to map a certificate in ACM to Cloudfront Distribution using AWS Console.
<img alt="CloudfrontSetting" src="cloudfront-setting.png" /></p>
<p>We also need make sure Cognito is our Authorizer for API Gateway (this time using CDK):
<div class="language-typescript highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">// Import User pool create by AWS Pre-config App</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">userPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cognito</span><span class="p">.</span><span class="nx">UserPool</span><span class="p">.</span><span class="nx">fromUserPoolArn</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pre-created-userpool&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;arn:aws:cognito-idp:region:accountID:userpool/region_cognitoID&quot;</span><span class="p">);</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1">// Register our Authorizer</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">apigw</span><span class="p">.</span><span class="nx">CognitoUserPoolsAuthorizer</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cognito-authorizer&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="nx">cognitoUserPools</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">userPool</span><span class="p">],</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="nx">authorizerName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;CognitoAuthorizer&quot;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">});</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="c1">// Require Authorizer in necessary method</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="kr">declare</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">backendApi</span><span class="o">:</span><span class="w"> </span><span class="kt">apigateway.LambdaRestApi</span><span class="p">;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kr">declare</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">lambdaIntegrate</span><span class="o">:</span><span class="w"> </span><span class="kt">apigateway.LambdaIntegration</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">backendApi</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">addResource</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">//your custom path</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="nx">items</span><span class="p">.</span><span class="nx">addMethod</span><span class="p">(</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="nx">lambdaIntegrate</span><span class="p">,</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">        </span><span class="nx">authorizationType</span><span class="o">:</span><span class="w"> </span><span class="kt">apigateway.AuthorizationType.COGNITO</span><span class="p">,</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">        </span><span class="nx">authorizer</span><span class="o">:</span><span class="w"> </span><span class="kt">auth</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="p">);</span>
</span></code></pre></div></p>
<h4 id="3-create-iam-ic-custom-app">3. Create IAM-IC custom app</h4>
<p>Now we need to tell Cognito to use IAM-IC as Identity provider and mapping attribute to custom app.</p>
<p>A little bit complicate here so I will note down step by step action (make sure to have 2 tabs open, 1 for IAM-IC and 1 for Cognito User pool)</p>
<ol>
<li>In IAM-IC tab, click to Applications in left side panel. Then Add application.<ul>
<li>Choose I have an application I want to set up, Application type is SAML 2.0. Hit next.</li>
<li>Put Display name and Description. Do <strong>NOT</strong> hit submit.</li>
<li>Copy IAM Identity Center SAML metadata file URL.</li>
</ul>
</li>
<li>In Cognito, open Sign-in experience tab. <ul>
<li>In Federated identity provider sign-in, click Add identity provider.</li>
<li>Choose SAML.</li>
<li>Provide a name for identity provider. Ex: IAMICProvider.</li>
<li>In Metadata document source, choose Enter metadata document endpoint URL and paste SAML metadata file URL in step 1 here.</li>
<li>Click Add identity provider.</li>
</ul>
</li>
<li>
<p>Move to App Integration tab.</p>
<ul>
<li>Scroll down to App clients and analytics and click to the app that created in there (Name format: UserPoolClient-<em>random string</em>).</li>
<li>Scroll to Hosted UI, click Edit.</li>
<li>Not sure what was the default value, so I will list everything here. Change to following value:</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>Allowed callback URLs</code></td>
<td style="text-align: left;"><em>https://your-frontend-url.com</em>/parseauth</td>
</tr>
<tr>
<td style="text-align: left;"><code>Allowed sign-out URLs</code></td>
<td style="text-align: left;"><em>https://your-frontend-url.com</em>/signout</td>
</tr>
<tr>
<td style="text-align: left;"><code>Identity providers</code></td>
<td style="text-align: left;">Identity provider created in step 2. Ex: IAMICProvider</td>
</tr>
<tr>
<td style="text-align: left;"><code>OAuth 2.0 grant types</code></td>
<td style="text-align: left;">Authorization code grant</td>
</tr>
<tr>
<td style="text-align: left;"><code>OpenID Connect scopes</code></td>
<td style="text-align: left;">Select everything</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Go back to user pool and in App integration tab.</p>
<ul>
<li>Copy Cognito domain.</li>
<li>Append <strong>/saml2/idpresponse</strong> to the domain URL. The result will be look something like:<br>
<mark>https://<em>cognito-custom-hash</em>.auth.<em>region</em>.amazoncognito.com<strong>/saml2/idpresponse</strong></mark></li>
<li>Go to IAM-IC tab and paste above value to Application ACS URL</li>
</ul>
</li>
<li>Go back to Cognito tab, copy User pool ID (ex: <strong>region_abcdEFGH</strong>)<ul>
<li>Append <code>urn:amazon:cognito:sp:</code> before User pool ID so we have a string like: <br>
<mark>urn:amazon:cognito:sp:<strong>region_abcdEFGH</strong></mark></li>
<li>Paste it to Application SAML audience in IAC-IC tab.</li>
</ul>
</li>
<li>
<p>I promise this will be the last settings <img alt="😅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f605.svg" title=":sweat_smile:" /></p>
<ul>
<li>Go back to IAC-IC tab.</li>
<li>Enter your <a href="https://your-frontend-url.com">https://your-frontend-url.com</a> to Application start URL.</li>
<li>Submit the app.</li>
<li>After submit the app, go to its detail setting.</li>
<li>Click Actions -&gt; Edit attribute mappings.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>Maps to this string value or user attribute in IAM Identity Center</code></td>
<td style="text-align: left;">${user:email}</td>
</tr>
<tr>
<td style="text-align: left;"><code>Format</code></td>
<td style="text-align: left;">emailAddress</td>
</tr>
</tbody>
</table>
<ul>
<li>Save. And we're done! <img alt="🎊" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f38a.svg" title=":confetti_ball:" /></li>
</ul>
</li>
</ol>
<h2 id="result">Result</h2>
<p>Now we have our own application and able to access it from AWS Portal!!!
<img alt="Result" src="result.png" /></p>
<p>Clinking it will open new tab to access our application. We can also access our application directly if enter <a href="https://your-frontend-url.com">https://your-frontend-url.com</a> in our browser. If not logged in, it will redirect to AWS portal and require user to login before continue.
<img alt="Result2" src="result2.png" /></p>
<h3 id="running-cost">Running cost</h3>
<ul>
<li>Using serverless, plus my system will not have too many requests daily. My estimate is about 5 per day (150 monthly).
You can say our system is basically free.</li>
<li>Using Cognito with SAML will be free as long as you keep the number of users below 50.</li>
<li>You do have to pay for Route53 host zone for backend and frontend URL. $0.50 per month. </li>
<li>Codebuild (in satellite accounts) On-demand might be the most expensive thing ($0.00425 per min). Assuming every time CodeBuild run, it will take 5 minutes. Monthly total will be $0.00425 * 5(min) * 5(times per day) * 30(days) = $3.1875</li>
<li><strong>Total cost</strong>: $0.50 + $3.1875 = $3.6875 (monthly)</li>
</ul>
<h2 id="summary">Summary</h2>
<p>Connecting Identities is not my strong point in any mean. But having Cognito (with little help from pre-config app from AWS) makes it so much easier. I'm using IAC-IC as my identity provider but I'm sure setting it up with other IDPs (Google Workspace, Microsoft AD, ..) is the same.</p>
<p>The estimated monthly cost is kept under $4, and with hundreds of dollars saved from turning off Development and Staging environment. I'm sure the system is extremely cost-effective, align perfectly with AWS pillar of well-architect.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 6, 2024</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 20, 2024</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/pitayapj" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  </body>
</html>